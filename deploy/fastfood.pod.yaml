apiVersion: v1
kind: Pod
metadata:
  name: fastfood-pod
  labels:
    app: fastfood
    io.containers.autoupdate: "image"
spec:
  automountServiceAccountToken: false
  containers:
  # 1. Backend Container (Node.js)
  - name: backend
    image: localhost/fastfood-backend:1.0.0
    ports:
    - name: internal-api
      containerPort: 3000
    env:
    - name: NODE_ENV
      value: "production"
    - name: PORT
      value: "3000"
    - name: MONGO_URI
      value: "mongodb://localhost:27017/fastfood"
    - name: JWT_SECRET
      value: "REPLACE_WITH_SECURE_SECRET_IN_PROD" # Should use Secret in real K8s, but Env fine for simplest Podman
    - name: ALLOWED_ORIGINS
      value: "https://fastfood.simonemiglio.eu"
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        memory: "512Mi"

  # 2. Database Container (MongoDB)
  - name: mongo
    image: docker.io/library/mongo:6
    ports:
    - name: db-port
      containerPort: 27017
    volumeMounts:
    - name: mongo-data
      mountPath: /data/db
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        memory: "1Gi"

  # 3. Sidecar Proxy (Caddy)
  - name: caddy
    image: docker.io/library/caddy:2-alpine
    ports:
    - name: http
      containerPort: 5000
      hostPort: 5000 # Exposed to the network
    volumeMounts:
    - name: frontend-dist
      mountPath: /usr/share/caddy
    - name: caddy-config
      mountPath: /etc/caddy
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        memory: "128Mi"

  volumes:
  # Host Path Mappings (Adjust paths to match your VPS structure)
  - name: mongo-data
    hostPath:
      path: /home/osvaldo/podman/data/fastfood/mongo_data
      type: DirectoryOrCreate
  - name: frontend-dist
    hostPath:
      path: /home/osvaldo/podman/data/fastfood/frontend_dist
      type: DirectoryOrCreate
  - name: caddy-config
    hostPath:
      path: /home/osvaldo/podman/data/fastfood/caddy_config
      type: DirectoryOrCreate
